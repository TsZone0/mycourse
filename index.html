<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Study Portal</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --sidebar-bg: #161b22;
            --nav-bg: #161b22;
            --card-bg: #161b22;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --success: #238636;
            --danger: #da3633;
            --pink-text: #ff79c6;
            --border: #30363d;
            --shadow: none;
        }

        [data-theme="light"] {
            --bg-dark: #f3f4f6;
            --sidebar-bg: #ffffff;
            --nav-bg: #ffffff;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --accent: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --pink-text: #db2777;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease; 
        }

        /* Message Toast */
        #message-toast {
            position: fixed; top: 70px; right: 20px; z-index: 300;
            padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 600; color: white; background: var(--accent);
            display: none; opacity: 0; transition: opacity 0.3s ease;
        }

        /* Login Screen */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: background-color 0.3s ease;
        }
        .login-card {
            background: var(--card-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border);
            width: 350px; text-align: center; box-shadow: var(--shadow);
        }
        .login-header { margin-bottom: 20px; }
        .login-toggle { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .toggle-btn { background: none; border: none; color: var(--text-muted); font-weight: bold; cursor: pointer; font-size: 1rem; padding-bottom: 5px; }
        .toggle-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        .login-input {
            width: 100%; padding: 12px; margin: 8px 0; background: var(--bg-dark);
            border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; outline: none;
        }
        .login-input:focus { border-color: var(--accent); }
        
        .google-btn {
            background: white; color: #333; padding: 10px 24px; border-radius: 6px; width: 100%;
            border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            font-size: 0.95rem; transition: 0.2s; margin-top: 15px;
        }
        .google-btn:hover { opacity: 0.9; }

        /* Navbar */
        .navbar {
            height: 60px; background-color: var(--nav-bg); border-bottom: 1px solid var(--border);
            display: none; align-items: center; justify-content: space-between; padding: 0 25px; z-index: 50;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .nav-links { display: flex; gap: 20px; height: 100%; }
        .nav-item { display: flex; align-items: center; cursor: pointer; color: var(--text-muted); padding: 0 10px; font-weight: 600; transition: 0.2s; }
        .nav-item:hover { color: var(--text-main); }
        .nav-item.active { color: var(--text-main); border-bottom: 2px solid var(--accent); }

        .theme-toggle {
            background: transparent; border: 1px solid var(--border); color: var(--text-main);
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            transition: 0.3s; margin-right: 10px;
        }
        .theme-toggle:hover { background: var(--bg-dark); border-color: var(--accent); }

        /* App Container */
        .app-container { display: none; flex: 1; overflow: hidden; position: relative; }

        /* Dashboard Grid */
        #home-view { width: 100%; height: 100%; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }
        .dashboard-row { display: flex; gap: 25px; flex-wrap: wrap; flex: 1; } 
        .dashboard-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }

        /* Stats & Heatmap (styles truncated for brevity) */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; box-shadow: var(--shadow); }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--text-main); display: block; margin: 5px 0; }
        .stat-label { color: var(--text-muted); font-size: 0.85rem; }

        /* Daily Goals (styles truncated for brevity) */
        .goals-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; flex: 1; box-shadow: var(--shadow); }
        .goal-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        /* Courses (styles truncated for brevity) */
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .course-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow); }

        /* Sidebar & Player */
        #course-view { display: none; width: 100%; height: 100%; display: flex; }
        .sidebar { width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; }
        .main-content { flex: 1; padding: 40px; background: var(--bg-dark); overflow-y: auto; display: flex; flex-direction: column; transition: 0.3s; }

        /* FIX: Topic list scrolling */
        #topic-list { 
            padding: 10px;
            flex: 1; /* Takes up remaining vertical space in the flex column parent (.sidebar) */
            overflow-y: auto; /* Enables vertical scrolling when content exceeds height */
        }
        
        .topic-item { padding: 12px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-muted); transition: 0.2s; border: 1px solid transparent; }
        .topic-item:hover { background: rgba(128,128,128,0.1); color: var(--text-main); }
        .topic-item.active { background: #1f6feb; color: white; }
        .topic-item.completed { background-color: var(--success) !important; color: white !important; font-weight: bold; border: 1px solid #2ea043; }
        [data-theme="light"] .topic-item.completed { color: white !important; }

        /* Utilities (styles truncated for brevity) */
        .btn-complete-done { background-color: var(--success) !important; color: var(--pink-text) !important; border-color: #2ea043; font-weight: bold; }
        [data-theme="light"] .btn-complete-done { color: white !important; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 6px; width: 400px; border: 1px solid var(--border); position: relative; box-shadow: var(--shadow); }
        .modal input { width: 100%; padding: 8px 12px; margin: 10px 0; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; }

    </style>
</head>
<body>
    <!-- Global Message Toast (Replacement for alert) -->
    <div id="message-toast" role="alert"></div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <h1 class="login-header">üéì Study Portal</h1>
            
            <!-- Toggle Tabs -->
            <div class="login-toggle">
                <button class="toggle-btn active" id="tab-login" onclick="toggleAuthMode('login')">Login</button>
                <button class="toggle-btn" id="tab-signup" onclick="toggleAuthMode('signup')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div id="login-form">
                <input type="email" id="login-email" class="login-input" placeholder="Email Address">
                <input type="password" id="login-pass" class="login-input" placeholder="Password">
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="handleEmailLogin()">Login</button>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" style="display: none;">
                <input type="text" id="signup-name" class="login-input" placeholder="Full Name">
                <input type="email" id="signup-email" class="login-input" placeholder="Email Address">
                <input type="password" id="signup-pass" class="login-input" placeholder="Password (Min 6 chars)">
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="handleSignUp()">Create Account</button>
            </div>

            <div class="loader" id="auth-loader"></div>
            <p id="login-error" style="color: var(--danger); margin-top: 20px; display: none; font-size: 0.9rem;"></p>

            <!-- Divider -->
            <div style="margin: 20px 0; color: var(--text-muted); font-size: 0.8rem;">OR</div>

            <!-- Google Login (Note: Google sign-in won't work in this environment unless fully configured externally) -->
            <button class="google-btn" onclick="showMessage('Google sign-in is not supported in this environment.')">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20" alt="G">
                Continue with Google
            </button>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar" id="main-nav">
        <div class="logo" onclick="switchView('home')" style="font-weight:bold; cursor:pointer;">üéì Study Portal</div>
        <div class="nav-links">
            <div class="nav-item active" id="nav-home" onclick="switchView('home')">Dashboard</div>
            <div class="nav-item" id="nav-course" onclick="if(currentCourseIndex > -1) switchView('course')">Course</div>
            <div class="nav-item" onclick="document.getElementById('about-modal').style.display='flex'">About</div>
            <div class="nav-item" onclick="document.getElementById('contact-modal').style.display='flex'">Contact</div>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                <span id="theme-icon">üåô</span>
            </button>
            <div style="color: var(--accent); font-weight: bold;">‚è±Ô∏è <span id="session-timer">00:00</span></div>
            <img id="user-pic" src="" style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); display:none;" alt="U">
            <button class="btn" style="padding: 4px 10px; font-size: 0.8rem;" onclick="handleLogout()">Logout</button>
        </div>
    </nav>

    <!-- Main App -->
    <div class="app-container" id="main-app">
        <!-- Dashboard View -->
        <div id="home-view">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 id="welcome-msg" style="font-size: 1.5rem;">Welcome!</h1>
            </div>
            <div class="dashboard-row">
                <div class="dashboard-col" style="flex: 2;">
                    <div class="stats-grid">
                        <div class="stat-card"><span class="stat-label">Study Today</span><span class="stat-value" id="stat-today">0m</span></div>
                        <div class="stat-card"><span class="stat-label">Total Hours</span><span class="stat-value" id="stat-total">0h</span></div>
                    </div>
                    <div class="heatmap-card">
                        <h3 style="margin-bottom: 15px; font-size: 1rem;">Study Consistency</h3>
                        <div class="heatmap-container" id="heatmap-grid"></div>
                    </div>
                    <h3 style="margin-top: 10px;">My Courses</h3>
                    <div class="courses-grid" id="courses-grid">
                        <div class="course-card add-new" onclick="openCreateModal()"><span style="font-size: 1.5rem;">+</span><span>New Course</span></div>
                    </div>
                </div>
                <div class="dashboard-col" style="flex: 1;">
                    <div class="goals-card">
                        <h3 style="margin-bottom: 15px; font-size: 1rem;">üéØ Daily Goals</h3>
                        <div class="goal-input-group">
                            <input type="text" id="new-goal-input" placeholder="Add task..." onkeypress="if(event.key==='Enter') addGoal()">
                            <button class="btn btn-primary" onclick="addGoal()">Add</button>
                        </div>
                        <ul class="goal-list" id="goal-list"></ul>
                    </div>
                </div>
            </div>
            <div class="app-footer">&copy; 2025 Copyright by <strong>Shivam Kumar (TIT(Excellence))</strong></div>
        </div>

        <!-- COURSE PLAYER -->
        <div id="course-view">
            <div class="sidebar">
                <div style="padding: 20px; border-bottom: 1px solid var(--border); background: var(--nav-bg);">
                    <h3 id="course-title-display" style="font-size: 1rem;">Loading...</h3>
                    <div style="margin-top: 10px; background: var(--border); height: 4px; border-radius: 2px;">
                        <div id="progress-bar" style="width: 0%; background: var(--success); height: 100%; border-radius: 2px;"></div>
                    </div>
                </div>
                <!-- FIX APPLIED HERE: #topic-list handles scrolling -->
                <div class="topic-list" id="topic-list"></div>
            </div>
            <div class="main-content">
                <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <button class="btn" onclick="switchView('home')">‚Üê Dashboard</button>
                        <button class="btn btn-primary" onclick="document.getElementById('add-topic-modal').style.display='flex'">+ Add Topic</button>
                    </div>
                    <div class="cinema-container"><iframe id="video-player" src="" allowfullscreen></iframe></div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="mark-btn" class="btn btn-primary" style="flex:1; padding: 12px;" onclick="markComplete()">‚úÖ Mark as Completed</button>
                        <button class="btn btn-danger" onclick="showDeleteTopicConfirm()" style="padding: 12px;">üóëÔ∏è</button>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                        <h2 id="video-title" style="color: var(--text-main);">Select Topic</h2>
                        <small id="completion-date" style="color: var(--pink-text); display: none;"></small>
                    </div>
                    <p id="video-desc" style="color: var(--text-muted); margin-top: 5px; margin-bottom: 20px;">...</p>
                    <div class="notes-section">
                        <h3>üìù Lecture Notes <span id="save-status" style="margin-left: auto; font-size: 0.8rem; color: var(--success);"></span></h3>
                        <textarea id="topic-notes" class="notes-area" placeholder="Write your key points here..."></textarea>
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="saveCurrentNote()">Save Note</button>
                    </div>
                    <button class="btn btn-danger" style="margin-top: 40px;" onclick="showDeleteCourseConfirm()">Delete Entire Course</button>
                </div>
                <div class="app-footer">&copy; 2025 Copyright by <strong>Shivam Kumar (TIT(Excellence))</strong></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="create-course-modal">
        <div class="modal-content">
            <h2>New Course</h2>
            <input type="text" id="new-course-name" placeholder="Course Name">
            <button class="btn btn-primary" style="width: 100%;" onclick="createNewCourse()">Create</button>
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="document.getElementById('create-course-modal').style.display='none'">Cancel</button>
        </div>
    </div>
    <div class="modal" id="add-topic-modal">
        <div class="modal-content">
            <h2>Add Lecture</h2>
            <input type="text" id="inp-title" placeholder="Title">
            <input type="text" id="inp-link" placeholder="YouTube Link (Full URL or Video ID)">
            <input type="text" id="inp-desc" placeholder="Description">
            <button class="btn btn-primary" style="width: 100%;" onclick="addTopic()">Add</button>
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="document.getElementById('add-topic-modal').style.display='none'">Cancel</button>
        </div>
    </div>
    
    <!-- Generic Confirmation Modal (Replaces confirm()) -->
    <div class="modal" id="generic-confirm-modal">
        <div class="modal-content">
            <h2 id="confirm-title" style="color: var(--danger);">Confirm Action</h2>
            <p id="confirm-message" style="margin: 15px 0; color: var(--text-main);"></p>
            <div style="display: flex; justify-content: space-between; gap: 10px;">
                <button class="btn btn-danger" style="flex: 1;" onclick="resolveConfirm(false)">Cancel</button>
                <button class="btn btn-primary" style="flex: 1; background: var(--danger);" onclick="resolveConfirm(true)">Delete</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="about-modal">
        <div class="modal-content" style="width: 500px;">
            <h2 style="margin-bottom: 20px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px;">üë®‚Äçüíª About Us</h2>
            
            <p style="color: var(--text-main); font-size: 1.05rem; line-height: 1.6; margin-bottom: 15px;">
                Hello everyone! I am <strong>Shivam Kumar</strong>, a passionate 2nd-year Computer Science Engineering student at <strong>TIT (Excellence)</strong>. üéì
            </p>

            <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 15px;">
                My journey into the world of technology has been driven by a single goal: to solve real-world problems using code. As a student myself, I realized that while platforms like YouTube have amazing educational content, they are also filled with distractions. One moment you are learning Data Structures, and the next you are watching funny videos.
            </p>

            <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 20px;">
                That is why I created this <strong>'Pro Study Portal'</strong>. It is a sanctuary for students‚Äîa place where you can organize your learning, track your progress with heatmaps, and maintain a focused study streak without the noise. This project is my contribution to helping every student achieve their academic goals with discipline and consistency.
            </p>
            
            <p style="color: var(--accent); font-weight: bold; text-align: center;">"Let's Crack It Together! üöÄ"</p>

            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="document.getElementById('about-modal').style.display='none'">Close</button>
        </div>
    </div>

    <div class="modal" id="contact-modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: var(--accent);">üìû Contact Us</h2>
            <a href="mailto:tszone@zohomail.in" class="contact-link"><span>üìß</span><div><div style="font-size: 0.8rem; color: var(--text-muted);">Email</div><div style="font-weight: bold;">tszone@zohomail.in</div></div></a>
            <a href="#" class="contact-link"><span>üíº</span><div><div style="font-size: 0.8rem; color: var(--text-muted);">LinkedIn</div><div style="font-weight: bold;">Connect with Shivam</div></div></a>
            <a href="#" class="contact-link"><span>üì∏</span><div><div style="font-size: 0.8rem; color: var(--text-muted);">Instagram</div><div style="font-weight: bold;">Follow for Updates</div></div></a>
            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="document.getElementById('contact-modal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            updateProfile, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, user, userId;
        setLogLevel('Debug'); // Enable Firestore logging

        // --- FIREBASE INIT ---
        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // IMPORTANT: Authenticate the user with the provided token or anonymously
                async function authenticateUser() {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Authentication failed:", e);
                        showAuthError("Authentication Failed. Please try again.");
                    }
                }
                authenticateUser();

            } catch (e) { 
                console.error("Firebase Init Error", e); 
            }
        } else {
            console.error("Firebase config not available. App will not save data.");
            // Fallback for UI visibility even without full persistence
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-nav').style.display = 'flex';
            document.getElementById('main-app').style.display = 'flex';
        }

        // --- STATE & DATA PATHS ---
        let courses = [], studyData = {}, dailyGoals = [];
        let currentCourseIndex = -1, currentTopicIndex = -1, sessionSeconds = 0, isSaving = false;

        function getUserDataDocRef(uid) {
             // Secure private data path for user data
            const userCollection = `/artifacts/${appId}/users/${uid}/data`;
            return doc(db, userCollection, 'study_data');
        }

        // --- UI UTILITIES (Replacement for alert/confirm) ---
        let confirmResolver;
        window.showMessage = (msg, duration = 3000) => {
            const toast = document.getElementById('message-toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.opacity = 1, 10);
            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => toast.style.display = 'none', 300);
            }, duration);
        }

        window.showConfirm = (title, message) => {
            return new Promise(resolve => {
                confirmResolver = resolve;
                document.getElementById('confirm-title').innerText = title;
                document.getElementById('confirm-message').innerText = message;
                document.getElementById('generic-confirm-modal').style.display = 'flex';
            });
        }
        window.resolveConfirm = (result) => {
            document.getElementById('generic-confirm-modal').style.display = 'none';
            if (confirmResolver) {
                confirmResolver(result);
                confirmResolver = null;
            }
        }
        
        // --- AUTH UI TOGGLE ---
        window.toggleAuthMode = (mode) => {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const tabLogin = document.getElementById('tab-login');
            const tabSignup = document.getElementById('tab-signup');
            const errorMsg = document.getElementById('login-error');
            
            errorMsg.style.display = 'none';

            if (mode === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                tabLogin.classList.add('active');
                tabSignup.classList.remove('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                tabLogin.classList.remove('active');
                tabSignup.classList.add('active');
            }
        }

        // --- AUTH ACTIONS ---
        
        // 1. Email Login
        window.handleEmailLogin = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) return showMessage("Please enter both email and password.");

            document.getElementById('auth-loader').style.display = 'block';
            signInWithEmailAndPassword(auth, email, pass)
                .catch((error) => {
                    showAuthError(error.message);
                });
        }

        // 2. Sign Up
        window.handleSignUp = () => {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;

            if(!name || !email || !pass) return showMessage("Please enter all fields.");

            document.getElementById('auth-loader').style.display = 'block';
            createUserWithEmailAndPassword(auth, email, pass)
                .then((result) => {
                    // Update Display Name
                    updateProfile(result.user, { displayName: name })
                        .then(() => {
                            document.getElementById('welcome-msg').innerText = `Welcome back, ${name}! üëã`;
                        });
                })
                .catch((error) => {
                    showAuthError(error.message);
                });
        }

        // 3. Google Login - Placeholder since it requires external setup not viable here
        window.handleGoogleLogin = () => {
             showMessage("Google Sign-In is not supported in this embedded environment. Please use Email/Password.");
        }

        function showAuthError(msg) {
            const el = document.getElementById('login-error');
            el.innerText = msg.replace("Firebase: Error (auth/", "").replace(").", "");
            el.style.display = 'block';
            document.getElementById('auth-loader').style.display = 'none';
        }

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (u) => {
            document.getElementById('auth-loader').style.display = 'none';
            if (u) {
                user = u;
                userId = u.uid;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-nav').style.display = 'flex';
                document.getElementById('main-app').style.display = 'flex';
                
                // Show full name here
                const name = user.displayName || 'Student';
                document.getElementById('welcome-msg').innerText = `Welcome back, ${name}! üëã`;
                
                if(user.photoURL) {
                    document.getElementById('user-pic').src = user.photoURL;
                    document.getElementById('user-pic').style.display = 'block';
                }
                await loadCloudData();
                initApp();
            } else {
                // Only show login screen if Firebase is configured
                if (firebaseConfig) {
                    document.getElementById('login-screen').style.display = 'flex';
                }
            }
        });

        // --- CLOUD & APP LOGIC ---
        async function loadCloudData() {
            if (!userId) return;
            try {
                const docRef = getUserDataDocRef(userId);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const data = snap.data();
                    courses = data.courses || []; 
                    studyData = data.studyData || {}; 
                    dailyGoals = data.dailyGoals || [];
                } else {
                    // Initialize and save defaults if document doesn't exist
                    courses = []; studyData = {}; dailyGoals = []; saveCloudData();
                }
            } catch (e) { 
                console.error("Load error", e); 
                showMessage("Could not load data. Check console for details.", 5000);
            }
        }

        async function saveCloudData() {
            if (!userId || isSaving) return;
            isSaving = true;
            try { 
                const docRef = getUserDataDocRef(userId);
                await setDoc(docRef, { courses, studyData, dailyGoals }, { merge: true }); 
            } catch(e) {
                console.error("Save error:", e);
                showMessage("Data failed to save.", 3000);
            }
            isSaving = false;
        }

        function initApp() {
            renderCourses(); renderHeatmap(); renderGoals(); updateStats();
            // Start the timer and study time tracker
            if (!window.sessionTimerInterval) {
                 window.sessionTimerInterval = setInterval(() => { sessionSeconds++; updateTimer(); }, 1000);
            }
            if (!window.studyTrackerInterval) {
                // Tracks study minutes (10 seconds interval = 10 study seconds)
                window.studyTrackerInterval = setInterval(() => { 
                    const today = new Date().toISOString().split('T')[0]; 
                    studyData[today] = (studyData[today] || 0) + 10; 
                    saveCloudData(); 
                    updateStats(); 
                }, 10000);
            }
        }

        // --- THEME ---
        window.toggleTheme = () => {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            document.getElementById('theme-icon').innerText = next === 'light' ? '‚òÄÔ∏è' : 'üåô';
        }
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.addEventListener('DOMContentLoaded', () => document.getElementById('theme-icon').innerText = savedTheme === 'light' ? '‚òÄÔ∏è' : 'üåô');

        // --- COURSE LOGIC ---
        window.openCreateModal = () => document.getElementById('create-course-modal').style.display='flex';
        window.createNewCourse = () => {
            const name = document.getElementById('new-course-name').value.trim();
            if(name) { 
                courses.push({ name, topics: [] }); 
                saveCloudData(); 
                renderCourses(); 
                document.getElementById('create-course-modal').style.display='none'; 
                document.getElementById('new-course-name').value = '';
                showMessage(`Course '${name}' created!`);
            } else {
                showMessage("Please enter a course name.");
            }
        }
        function renderCourses() {
            const grid = document.getElementById('courses-grid');
            const addBtn = grid.querySelector('.add-new');
            grid.querySelectorAll('.course-card:not(.add-new)').forEach(e => e.remove());
            courses.forEach((c, idx) => {
                const totalTopics = c.topics.length;
                const completedTopics = c.topics.filter(t => t.completed).length;
                const progress = totalTopics > 0 ? (completedTopics / totalTopics) * 100 : 0;
                
                const div = document.createElement('div');
                div.className = 'course-card';
                div.innerHTML = `
                    <h3 style="margin-bottom: 5px;">${c.name}</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem;">${totalTopics} Topics | ${completedTopics} Done</p>
                    <div style="margin-top: 10px; background: var(--border); height: 4px; border-radius: 2px;">
                        <div style="width: ${progress}%; background: ${progress === 100 ? 'var(--success)' : 'var(--accent)'}; height: 100%; border-radius: 2px;"></div>
                    </div>
                `;
                div.onclick = () => loadCourse(idx);
                grid.insertBefore(div, addBtn);
            });
        }
        window.loadCourse = (idx) => {
            currentCourseIndex = idx;
            currentTopicIndex = -1; // Reset topic index when switching courses
            const c = courses[idx];
            document.getElementById('course-title-display').innerText = c.name;
            
            // Activate the Course nav link
            document.getElementById('nav-course').style.display = 'flex'; // Ensure link is visible
            document.getElementById('nav-course').classList.add('active'); 

            switchView('course');
            renderTopics();
            if(c.topics.length > 0) {
                loadTopic(0);
            } else {
                document.getElementById('video-player').src = '';
                document.getElementById('video-title').innerText = "Course created. Add your first topic!";
                document.getElementById('video-desc').innerText = "Use the '+ Add Topic' button above to get started.";
                document.getElementById('mark-btn').style.display = 'none';
                document.getElementById('topic-notes').value = "";
                document.getElementById('completion-date').style.display = 'none';
            }
        }
        function renderTopics() {
            if (currentCourseIndex < 0) return;
            const list = document.getElementById('topic-list');
            list.innerHTML = '';
            const t = courses[currentCourseIndex].topics;
            let done = 0;
            t.forEach((topic, i) => {
                if(topic.completed) done++;
                const div = document.createElement('div');
                div.className = `topic-item ${i===currentTopicIndex?'active':''} ${topic.completed?'completed':''}`;
                div.innerHTML = `<span>${i+1}. ${topic.title}</span><span>${topic.completed?'‚úì':''}</span>`;
                div.onclick = () => loadTopic(i);
                list.appendChild(div);
            });
            document.getElementById('progress-bar').style.width = t.length ? (done/t.length)*100+'%' : '0%';
        }
        window.loadTopic = (i) => {
            currentTopicIndex = i;
            const t = courses[currentCourseIndex].topics[i];
            
            // Parse notes safely, handling old structure if necessary
            let noteContent = t.notes || "";
            try {
                // If notes were saved as a string (the new way)
                noteContent = t.notes || "";
            } catch(e) {
                console.warn("Could not parse notes, using raw data.");
                noteContent = t.notes || "";
            }

            document.getElementById('video-player').src = t.url;
            document.getElementById('video-title').innerText = t.title;
            document.getElementById('video-desc').innerText = t.desc;
            document.getElementById('topic-notes').value = noteContent;
            document.getElementById('save-status').innerText = "";
            const btn = document.getElementById('mark-btn');
            const dateEl = document.getElementById('completion-date');
            btn.style.display = 'block';
            
            if (t.completed) {
                btn.innerHTML = "üéâ Completed";
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-complete-done');
                if(t.completedOn) {
                    const date = new Date(t.completedOn).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    dateEl.innerText = `Completed on: ${date}`;
                    dateEl.style.display = 'block';
                }
            } else {
                btn.innerHTML = "‚úÖ Mark as Completed";
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-complete-done');
                dateEl.style.display = 'none';
            }
            renderTopics();
        }
        window.addTopic = () => {
            const title = document.getElementById('inp-title').value.trim();
            const link = document.getElementById('inp-link').value.trim();
            const desc = document.getElementById('inp-desc').value.trim();
            
            if (!title || !link) return showMessage("Title and Link are required.");

            // Regex to extract YouTube ID from various formats
            const match = link.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|shorts\/)([^"&?\/ ]{11})/i);
            
            if(match && match[1].length === 11) {
                const videoId = match[1];
                courses[currentCourseIndex].topics.push({
                    title, 
                    desc, 
                    completed: false, 
                    completedOn: null, 
                    notes: "",
                    url: `https://www.youtube.com/embed/${videoId}?modestbranding=1&rel=0&loop=1&playlist=${videoId}`
                });
                saveCloudData();
                renderTopics();
                document.getElementById('add-topic-modal').style.display='none';
                document.getElementById('inp-title').value = '';
                document.getElementById('inp-link').value = '';
                document.getElementById('inp-desc').value = '';
                if(courses[currentCourseIndex].topics.length === 1) loadTopic(0);
                showMessage(`Topic '${title}' added.`);
            } else { 
                showMessage("Invalid YouTube Link. Please use a valid video URL.", 4000); 
            }
        }
        window.markComplete = () => {
            if(currentTopicIndex > -1) {
                const topic = courses[currentCourseIndex].topics[currentTopicIndex];
                topic.completed = !topic.completed;
                topic.completedOn = topic.completed ? new Date().toISOString() : null;
                saveCloudData();
                loadTopic(currentTopicIndex);
                showMessage(topic.completed ? `Topic marked completed! Great job!` : `Topic marked incomplete.`);
            }
        }

        window.showDeleteTopicConfirm = async () => {
            if(currentTopicIndex < 0) return showMessage("Please select a topic first.");
            const topicName = courses[currentCourseIndex].topics[currentTopicIndex].title;
            const confirmed = await showConfirm(`Delete Topic: ${topicName}`, `Are you sure you want to permanently delete this lecture? This cannot be undone.`);
            if (confirmed) {
                deleteTopic();
            }
        }
        function deleteTopic() {
            courses[currentCourseIndex].topics.splice(currentTopicIndex, 1);
            saveCloudData();
            renderTopics();
            currentTopicIndex = -1; // Reset topic selection
            
            if(courses[currentCourseIndex].topics.length > 0) {
                loadTopic(0);
            } else {
                 // Clear player when no topics remain
                document.getElementById('video-player').src = '';
                document.getElementById('video-title').innerText = "No Topic. Add one!";
                document.getElementById('video-desc').innerText = "...";
                document.getElementById('mark-btn').style.display = 'none';
                document.getElementById('topic-notes').value = "";
                document.getElementById('completion-date').style.display = 'none';
            }
            showMessage("Topic deleted successfully.");
        }

        window.showDeleteCourseConfirm = async () => {
            if(currentCourseIndex < 0) return showMessage("Please select a course first.");
            const courseName = courses[currentCourseIndex].name;
            const confirmed = await showConfirm(`Delete Course: ${courseName}`, `Are you sure you want to permanently delete the entire course? This cannot be undone.`);
            if (confirmed) {
                deleteCourse();
            }
        }
        function deleteCourse() {
            courses.splice(currentCourseIndex, 1);
            saveCloudData();
            currentCourseIndex = -1; // Reset course selection
            switchView('home');
            renderCourses();
            showMessage("Course deleted successfully.");
        }
        
        window.saveCurrentNote = () => {
            if(currentTopicIndex > -1 && currentCourseIndex > -1) {
                const noteContent = document.getElementById('topic-notes').value;
                courses[currentCourseIndex].topics[currentTopicIndex].notes = noteContent;
                saveCloudData();
                const status = document.getElementById('save-status');
                status.innerText = "Saved to Cloud ‚úÖ";
                setTimeout(() => status.innerText = "", 2000);
            }
        }
        
        // --- GOAL LOGIC ---
        window.addGoal = () => {
            const input = document.getElementById('new-goal-input');
            const txt = input.value.trim();
            if (txt) { dailyGoals.push({ text: txt, done: false }); saveCloudData(); renderGoals(); input.value = ''; }
        }
        window.toggleGoal = (idx) => { dailyGoals[idx].done = !dailyGoals[idx].done; saveCloudData(); renderGoals(); }
        window.deleteGoal = (idx) => { dailyGoals.splice(idx, 1); saveCloudData(); renderGoals(); }
        function renderGoals() {
            const list = document.getElementById('goal-list');
            list.innerHTML = '';
            dailyGoals.forEach((g, i) => {
                const li = document.createElement('li');
                li.className = `goal-item ${g.done ? 'goal-done' : ''}`;
                li.innerHTML = `<input type="checkbox" class="goal-checkbox" ${g.done ? 'checked' : ''} onchange="toggleGoal(${i})"><span class="goal-text">${g.text}</span><span class="delete-goal" onclick="deleteGoal(${i})">√ó</span>`;
                list.appendChild(li);
            });
        }
        
        // --- STATS LOGIC ---
        function updateTimer() {
            const m = Math.floor(sessionSeconds/60);
            const s = sessionSeconds%60;
            document.getElementById('session-timer').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const tSec = studyData[today] || 0;
            let total = 0;
            Object.values(studyData).forEach(v => total += v);
            document.getElementById('stat-today').innerText = (tSec/60).toFixed(0) + 'm';
            document.getElementById('stat-total').innerText = (total/3600).toFixed(1) + 'h';
            renderHeatmap(); // Update heatmap whenever stats change
        }
        function renderHeatmap() {
            const container = document.getElementById('heatmap-grid');
            container.innerHTML = '';
            const today = new Date();
            const year = today.getFullYear();
            
            // Generate 365 days of cells (or fewer if the year hasn't passed)
            const daysInYear = (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0 ? 366 : 365;
            const startDate = new Date(year, 0, 1);
            let dayIndex = 0;
            let currentMonth = -1;
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const monthLabels = document.createElement('div');
            monthLabels.style.display = 'flex';
            monthLabels.style.flexWrap = 'nowrap';
            monthLabels.style.gap = '3px';
            monthLabels.style.alignItems = 'flex-start';
            monthLabels.style.width = '100%';

            // Create a pseudo-calendar structure for 365 days
            const dayGrid = document.createElement('div');
            dayGrid.style.display = 'grid';
            // 7 days per week, and approximately 52 weeks in a year (52 * 7 = 364)
            dayGrid.style.gridTemplateColumns = 'repeat(53, 10px)'; 
            dayGrid.style.gridTemplateRows = 'repeat(7, 10px)'; 
            dayGrid.style.gap = '3px';
            
            for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayOfWeek = d.getDay(); // 0 (Sun) to 6 (Sat)
                
                // Add month label at start of month
                if (d.getMonth() !== currentMonth) {
                    currentMonth = d.getMonth();
                    const label = document.createElement('div');
                    label.className = 'heatmap-month-label';
                    label.innerText = monthNames[currentMonth];
                    label.style.gridColumnStart = Math.floor(dayIndex / 7) + 1;
                    label.style.gridRowStart = 1;
                    monthLabels.appendChild(label);
                }

                const seconds = studyData[dateStr] || 0;
                const mins = seconds / 60;
                let level = 'h-l0';
                if (mins > 120) level = 'h-l4'; 
                else if (mins > 60) level = 'h-l3'; 
                else if (mins > 30) level = 'h-l2'; 
                else if (mins > 0) level = 'h-l1';
                
                const cell = document.createElement('div');
                cell.className = `heatmap-cell ${level}`;
                cell.title = `${dateStr}: ${Math.round(mins)} mins`;
                
                // Position cell in the grid
                cell.style.gridRow = dayOfWeek === 0 ? 7 : dayOfWeek; // Monday to Saturday = 1 to 6, Sunday = 7
                cell.style.gridColumn = Math.floor(dayIndex / 7) + 1;
                
                dayGrid.appendChild(cell);
                dayIndex++;
            }

            container.style.display = 'block';
            container.appendChild(monthLabels);
            container.appendChild(dayGrid);
        }

        window.switchView = (v) => {
            document.getElementById('home-view').style.display = v==='home'?'flex':'none';
            document.getElementById('course-view').style.display = v==='course'?'flex':'none';
            document.getElementById('nav-home').classList.toggle('active', v==='home');
            document.getElementById('nav-course').classList.toggle('active', v==='course');
            if(v==='home') renderCourses();
        }

    </script>
</body>
</html>
