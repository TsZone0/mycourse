<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Study Portal (Cloud Sync)</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --sidebar-bg: #161b22;
            --nav-bg: #161b22;
            --card-bg: #161b22;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --success: #238636;
            --danger: #da3633;
            --border: #30363d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Login Screen */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .google-btn {
            background: white; color: #333; padding: 12px 24px; border-radius: 6px;
            border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px;
            font-size: 1rem; transition: 0.2s;
        }
        .google-btn:hover { opacity: 0.9; }

        /* Navbar */
        .navbar {
            height: 60px; background-color: var(--nav-bg); border-bottom: 1px solid var(--border);
            display: none; align-items: center; justify-content: space-between; padding: 0 25px; z-index: 50;
        }
        .nav-links { display: flex; gap: 20px; height: 100%; }
        .nav-item { display: flex; align-items: center; cursor: pointer; color: var(--text-muted); padding: 0 10px; font-weight: 600; transition: 0.2s; }
        .nav-item:hover { color: var(--text-main); }
        .nav-item.active { color: var(--text-main); border-bottom: 2px solid var(--accent); }

        /* App Container */
        .app-container { display: none; flex: 1; overflow: hidden; position: relative; }

        /* Dashboard Grid */
        #home-view { width: 100%; height: 100%; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }
        
        .dashboard-row { display: flex; gap: 25px; flex-wrap: wrap; }
        .dashboard-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--text-main); display: block; margin: 5px 0; }
        .stat-label { color: var(--text-muted); font-size: 0.85rem; }

        /* Heatmap */
        .heatmap-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; overflow-x: auto; }
        .heatmap-grid { display: flex; gap: 3px; min-width: max-content; }
        .heatmap-col { display: flex; flex-direction: column; gap: 3px; }
        .heatmap-cell { width: 12px; height: 12px; border-radius: 2px; background: #161b22; border: 1px solid #282e36; }
        .h-l0 { background: #161b22; }
        .h-l1 { background: #0e4429; border-color: #0e4429; }
        .h-l2 { background: #006d32; border-color: #006d32; }
        .h-l3 { background: #26a641; border-color: #26a641; }
        .h-l4 { background: #39d353; border-color: #39d353; }

        /* Daily Goals */
        .goals-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; flex: 1; }
        .goal-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .goal-list { list-style: none; max-height: 300px; overflow-y: auto; }
        .goal-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border); }
        .goal-item:last-child { border-bottom: none; }
        .goal-checkbox { width: 18px; height: 18px; accent-color: var(--success); cursor: pointer; }
        .goal-text { flex: 1; }
        .goal-done .goal-text { text-decoration: line-through; color: var(--text-muted); }
        .delete-goal { color: var(--text-muted); cursor: pointer; font-size: 1.2rem; }
        .delete-goal:hover { color: var(--danger); }

        /* Courses */
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .course-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; cursor: pointer; transition: border-color 0.2s; }
        .course-card:hover { border-color: var(--accent); }
        .add-new { border: 1px dashed var(--text-muted); display: flex; align-items: center; justify-content: center; flex-direction: column; background: transparent; }

        /* Sidebar & Player */
        #course-view { display: none; width: 100%; height: 100%; }
        .sidebar { width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 40px; background: var(--bg-dark); overflow-y: auto; }
        .topic-item { padding: 12px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-muted); }
        .topic-item:hover { background: #21262d; color: var(--text-main); }
        .topic-item.active { background: #1f6feb; color: white; }
        .topic-item.completed { color: var(--success); }
        
        .cinema-container { width: 100%; max-width: 900px; aspect-ratio: 16/9; background: #000; border-radius: 6px; margin-bottom: 20px; border: 1px solid var(--border); }
        iframe { width: 100%; height: 100%; border: none; }

        /* Utilities */
        .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid rgba(27,31,36,0.15); cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-primary { background: #238636; color: white; border: 1px solid rgba(27,31,36,0.15); }
        .btn-primary:hover { background: #2ea043; }
        .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--border); }
        .btn-danger:hover { color: white; background: var(--danger); border-color: var(--danger); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 6px; width: 400px; border: 1px solid var(--border); position: relative; }
        .modal input { width: 100%; padding: 8px 12px; margin: 10px 0; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; }

        .contact-link { display: flex; align-items: center; gap: 15px; color: var(--text-main); text-decoration: none; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px; transition: 0.2s; }
        .contact-link:hover { border-color: var(--accent); color: var(--accent); transform: translateX(5px); }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <h1 style="margin-bottom: 20px;">üéì My Study Portal</h1>
        <p style="color: var(--text-muted); margin-bottom: 40px;">Login to sync your consistency & goals.</p>
        <button class="google-btn" onclick="handleLogin()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20" alt="G">
            Sign in with Google
        </button>
        <div class="loader" id="auth-loader" style="margin-top: 20px;"></div>
        <p id="login-error" style="color: var(--danger); margin-top: 20px; display: none;"></p>
    </div>

    <!-- Navbar -->
    <nav class="navbar" id="main-nav">
        <div class="logo" onclick="switchView('home')" style="font-weight:bold; cursor:pointer;">üéì Study Portal</div>
        <div class="nav-links">
            <div class="nav-item active" id="nav-home" onclick="switchView('home')">Dashboard</div>
            <div class="nav-item" id="nav-course" onclick="if(currentCourseIndex > -1) switchView('course')">Course</div>
            <div class="nav-item" onclick="document.getElementById('about-modal').style.display='flex'">About Us</div>
            <div class="nav-item" onclick="document.getElementById('contact-modal').style.display='flex'">Contact</div>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div style="color: var(--accent); font-weight: bold;">‚è±Ô∏è <span id="session-timer">00:00</span></div>
            <img id="user-pic" src="" style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border);" alt="U">
            <button class="btn" style="padding: 4px 10px; font-size: 0.8rem;" onclick="handleLogout()">Logout</button>
        </div>
    </nav>

    <!-- Main App -->
    <div class="app-container" id="main-app">
        
        <!-- DASHBOARD -->
        <div id="home-view">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 id="welcome-msg" style="font-size: 1.5rem;">Welcome!</h1>
            </div>
            
            <div class="dashboard-row">
                <!-- Left Col: Heatmap & Courses -->
                <div class="dashboard-col" style="flex: 2;">
                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-label">Study Today</span>
                            <span class="stat-value" id="stat-today">0m</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Total Hours</span>
                            <span class="stat-value" id="stat-total">0h</span>
                        </div>
                    </div>

                    <!-- Heatmap -->
                    <div class="heatmap-card">
                        <h3 style="margin-bottom: 15px; font-size: 1rem;">Study Consistency (Last 365 Days)</h3>
                        <div class="heatmap-grid" id="heatmap-grid"></div>
                        <div style="display: flex; gap: 5px; align-items: center; margin-top: 10px; font-size: 0.75rem; color: var(--text-muted);">
                            <span>Less</span>
                            <div class="heatmap-cell h-l0"></div>
                            <div class="heatmap-cell h-l1"></div>
                            <div class="heatmap-cell h-l2"></div>
                            <div class="heatmap-cell h-l3"></div>
                            <div class="heatmap-cell h-l4"></div>
                            <span>More</span>
                        </div>
                    </div>

                    <!-- Courses -->
                    <h3 style="margin-top: 10px; font-size: 1.2rem;">My Courses</h3>
                    <div class="courses-grid" id="courses-grid">
                        <div class="course-card add-new" onclick="openCreateModal()">
                            <span style="font-size: 1.5rem;">+</span>
                            <span>New Course</span>
                        </div>
                    </div>
                </div>

                <!-- Right Col: Daily Goals -->
                <div class="dashboard-col" style="flex: 1;">
                    <div class="goals-card">
                        <h3 style="margin-bottom: 15px; font-size: 1rem;">üéØ Daily Goals</h3>
                        <div class="goal-input-group">
                            <input type="text" id="new-goal-input" placeholder="Add a task..." onkeypress="if(event.key==='Enter') addGoal()">
                            <button class="btn btn-primary" onclick="addGoal()">Add</button>
                        </div>
                        <ul class="goal-list" id="goal-list">
                            <!-- Goals injected here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- COURSE PLAYER -->
        <div id="course-view">
            <div class="sidebar">
                <div style="padding: 20px; border-bottom: 1px solid var(--border); background: #0d1117;">
                    <h3 id="course-title-display" style="font-size: 1rem;">Loading...</h3>
                    <div style="margin-top: 10px; background: #30363d; height: 4px; border-radius: 2px;">
                        <div id="progress-bar" style="width: 0%; background: var(--success); height: 100%; border-radius: 2px;"></div>
                    </div>
                </div>
                <div class="topic-list" id="topic-list" style="padding: 10px;"></div>
            </div>
            <div class="main-content">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <button class="btn" onclick="switchView('home')">‚Üê Dashboard</button>
                    <button class="btn btn-primary" onclick="document.getElementById('add-topic-modal').style.display='flex'">+ Add Topic</button>
                </div>
                <div class="cinema-container"><iframe id="video-player" src="" allowfullscreen></iframe></div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="mark-btn" class="btn btn-primary" style="flex:1; padding: 12px;" onclick="markComplete()">‚úÖ Mark as Completed</button>
                    <button class="btn btn-danger" onclick="deleteTopic()" style="padding: 12px;">üóëÔ∏è</button>
                </div>
                <div style="margin-top: 20px; color: var(--text-muted);">
                    <h2 id="video-title" style="color: var(--text-main);">Select Topic</h2>
                    <p id="video-desc" style="margin-top: 5px;">...</p>
                    <button class="btn btn-danger" style="margin-top: 20px;" onclick="deleteCourse()">Delete Entire Course</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div class="modal" id="create-course-modal">
        <div class="modal-content">
            <h2>New Course</h2>
            <input type="text" id="new-course-name" placeholder="Course Name">
            <button class="btn btn-primary" style="width: 100%;" onclick="createNewCourse()">Create</button>
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="document.getElementById('create-course-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div class="modal" id="add-topic-modal">
        <div class="modal-content">
            <h2>Add Lecture</h2>
            <input type="text" id="inp-title" placeholder="Title">
            <input type="text" id="inp-link" placeholder="YouTube Link">
            <input type="text" id="inp-desc" placeholder="Description">
            <button class="btn btn-primary" style="width: 100%;" onclick="addTopic()">Add</button>
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="document.getElementById('add-topic-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <!-- New Modals: About & Contact -->
    <div class="modal" id="about-modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px; color: var(--accent);">üë®‚Äçüíª About Us</h2>
            <p style="color: var(--text-main); margin-bottom: 15px; font-size: 1.1rem;">
                Hello! I am <strong>Shivam</strong>, a 2nd year CSE student. üéì
            </p>
            <p style="color: var(--text-muted); line-height: 1.6;">
                We created this webpage for students to help them stay consistent and focused. This portal allows you to organize your YouTube learning, track your daily progress, and maintain a study streak without distractions.
            </p>
            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="document.getElementById('about-modal').style.display='none'">Close</button>
        </div>
    </div>

    <div class="modal" id="contact-modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: var(--accent);">üìû Contact Us</h2>
            
            <a href="mailto:tszone@zohomail.in" class="contact-link">
                <span style="font-size: 1.5rem;">üìß</span>
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Email</div>
                    <div style="font-weight: bold;">tszone@zohomail.in</div>
                </div>
            </a>

            <a href="#" target="_blank" class="contact-link">
                <span style="font-size: 1.5rem;">üíº</span>
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">LinkedIn</div>
                    <div style="font-weight: bold;">Connect with Shivam</div>
                </div>
            </a>

            <a href="#" target="_blank" class="contact-link">
                <span style="font-size: 1.5rem;">üì∏</span>
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Instagram</div>
                    <div style="font-weight: bold;">Follow for Updates</div>
                </div>
            </a>

            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="document.getElementById('contact-modal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- FIREBASE CONFIG (Same as before) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCf-BoHSE_-2YhF7DAbxYXT0cHOprE9rzk",
            authDomain: "mycourse-231f1.firebaseapp.com",
            projectId: "mycourse-231f1",
            storageBucket: "mycourse-231f1.firebasestorage.app",
            messagingSenderId: "519848272346",
            appId: "1:519848272346:android:b495935905823e921920e3" 
        };

        let app, auth, db, user;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase Init Error", e); }

        // --- STATE ---
        let courses = [];
        let studyData = {};
        let dailyGoals = [];
        let currentCourseIndex = -1;
        let currentTopicIndex = -1;
        let sessionSeconds = 0;
        let isSaving = false;

        // --- AUTH ---
        window.handleLogin = () => {
            document.getElementById('auth-loader').style.display = 'block';
            signInWithPopup(auth, new GoogleAuthProvider()).catch(e => {
                document.getElementById('login-error').innerText = e.message;
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('auth-loader').style.display = 'none';
            });
        }
        window.handleLogout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (u) => {
            document.getElementById('auth-loader').style.display = 'none';
            if (u) {
                user = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-nav').style.display = 'flex';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('user-pic').src = user.photoURL;
                document.getElementById('welcome-msg').innerText = `Welcome back, ${user.displayName.split(' ')[0]}! üëã`;
                await loadCloudData();
                initApp();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        });

        // --- CLOUD ---
        async function loadCloudData() {
            try {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    const data = snap.data();
                    courses = data.courses || [];
                    studyData = data.studyData || {};
                    dailyGoals = data.dailyGoals || [];
                } else {
                    courses = [];
                    studyData = {};
                    dailyGoals = [];
                    saveCloudData();
                }
            } catch (e) { console.error("Load error", e); }
        }

        async function saveCloudData() {
            if (!user || isSaving) return;
            isSaving = true;
            try {
                await setDoc(doc(db, "users", user.uid), { courses, studyData, dailyGoals }, { merge: true });
            } catch(e) { console.error("Save error", e); }
            isSaving = false;
        }

        // --- APP INIT ---
        function initApp() {
            renderCourses();
            renderHeatmap();
            renderGoals();
            updateStats();
            setInterval(() => { sessionSeconds++; updateTimer(); }, 1000);
            setInterval(() => {
                const today = new Date().toISOString().split('T')[0];
                studyData[today] = (studyData[today] || 0) + 10;
                saveCloudData();
                updateStats();
            }, 10000);
        }

        // --- FEATURES ---
        function renderHeatmap() {
            const grid = document.getElementById('heatmap-grid');
            grid.innerHTML = '';
            const today = new Date();
            const startDate = new Date();
            startDate.setDate(today.getDate() - 365);
            while(startDate.getDay() !== 0) { startDate.setDate(startDate.getDate() - 1); }
            let currentDate = new Date(startDate);
            while (currentDate <= today) {
                const col = document.createElement('div');
                col.className = 'heatmap-col';
                for (let i = 0; i < 7; i++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const mins = (studyData[dateStr] || 0) / 60;
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.title = `${dateStr}: ${Math.round(mins)} mins`;
                    if (mins > 120) cell.classList.add('h-l4');
                    else if (mins > 60) cell.classList.add('h-l3');
                    else if (mins > 30) cell.classList.add('h-l2');
                    else if (mins > 0) cell.classList.add('h-l1');
                    else cell.classList.add('h-l0');
                    col.appendChild(cell);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                grid.appendChild(col);
            }
            grid.parentElement.scrollLeft = grid.parentElement.scrollWidth;
        }

        window.addGoal = () => {
            const input = document.getElementById('new-goal-input');
            const txt = input.value.trim();
            if (txt) {
                dailyGoals.push({ text: txt, done: false });
                saveCloudData();
                renderGoals();
                input.value = '';
            }
        }

        window.toggleGoal = (idx) => {
            dailyGoals[idx].done = !dailyGoals[idx].done;
            saveCloudData();
            renderGoals();
        }

        window.deleteGoal = (idx) => {
            dailyGoals.splice(idx, 1);
            saveCloudData();
            renderGoals();
        }

        function renderGoals() {
            const list = document.getElementById('goal-list');
            list.innerHTML = '';
            dailyGoals.forEach((g, i) => {
                const li = document.createElement('li');
                li.className = `goal-item ${g.done ? 'goal-done' : ''}`;
                li.innerHTML = `<input type="checkbox" class="goal-checkbox" ${g.done ? 'checked' : ''} onchange="toggleGoal(${i})"><span class="goal-text">${g.text}</span><span class="delete-goal" onclick="deleteGoal(${i})">√ó</span>`;
                list.appendChild(li);
            });
        }

        // --- EXISTING LOGIC ---
        function updateTimer() {
            const m = Math.floor(sessionSeconds/60);
            const s = sessionSeconds%60;
            document.getElementById('session-timer').innerText = `${m}:${s<10?'0'+s:s}`;
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const tSec = studyData[today] || 0;
            let total = 0;
            Object.values(studyData).forEach(v => total += v);
            document.getElementById('stat-today').innerText = (tSec/60).toFixed(0) + 'm';
            document.getElementById('stat-total').innerText = (total/3600).toFixed(1) + 'h';
        }

        window.openCreateModal = () => document.getElementById('create-course-modal').style.display='flex';
        window.createNewCourse = () => {
            const name = document.getElementById('new-course-name').value;
            if(name) {
                courses.push({ name, topics: [] });
                saveCloudData();
                renderCourses();
                document.getElementById('create-course-modal').style.display='none';
            }
        }

        function renderCourses() {
            const grid = document.getElementById('courses-grid');
            const addBtn = grid.querySelector('.add-new');
            grid.querySelectorAll('.course-card:not(.add-new)').forEach(e => e.remove());
            courses.forEach((c, idx) => {
                const div = document.createElement('div');
                div.className = 'course-card';
                div.innerHTML = `<h3>${c.name}</h3><p style="color:var(--text-muted); font-size:0.9rem;">${c.topics.length} Topics</p>`;
                div.onclick = () => loadCourse(idx);
                grid.insertBefore(div, addBtn);
            });
        }

        window.loadCourse = (idx) => {
            currentCourseIndex = idx;
            const c = courses[idx];
            document.getElementById('course-title-display').innerText = c.name;
            switchView('course');
            renderTopics();
            if(c.topics.length > 0) loadTopic(0);
            else {
                document.getElementById('video-player').src = '';
                document.getElementById('video-title').innerText = "No Topic";
            }
        }

        function renderTopics() {
            const list = document.getElementById('topic-list');
            list.innerHTML = '';
            const t = courses[currentCourseIndex].topics;
            let done = 0;
            t.forEach((topic, i) => {
                if(topic.completed) done++;
                const div = document.createElement('div');
                div.className = `topic-item ${i===currentTopicIndex?'active':''} ${topic.completed?'completed':''}`;
                div.innerHTML = `<span>${i+1}. ${topic.title}</span><span>${topic.completed?'‚úì':''}</span>`;
                div.onclick = () => loadTopic(i);
                list.appendChild(div);
            });
            document.getElementById('progress-bar').style.width = t.length ? (done/t.length)*100+'%' : '0%';
        }

        window.loadTopic = (i) => {
            currentTopicIndex = i;
            const t = courses[currentCourseIndex].topics[i];
            document.getElementById('video-player').src = t.url;
            document.getElementById('video-title').innerText = t.title;
            document.getElementById('video-desc').innerText = t.desc;
            renderTopics();
        }

        window.addTopic = () => {
            const title = document.getElementById('inp-title').value;
            const link = document.getElementById('inp-link').value;
            const desc = document.getElementById('inp-desc').value;
            const match = link.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?]*).*/);
            if(match && match[2].length===11) {
                courses[currentCourseIndex].topics.push({
                    title, desc, completed: false,
                    url: `https://www.youtube.com/embed/${match[2]}?modestbranding=1&rel=0&loop=1&playlist=${match[2]}`
                });
                saveCloudData();
                renderTopics();
                document.getElementById('add-topic-modal').style.display='none';
                if(courses[currentCourseIndex].topics.length===1) loadTopic(0);
            } else { alert("Invalid Link"); }
        }

        window.markComplete = () => {
            if(currentTopicIndex > -1) {
                courses[currentCourseIndex].topics[currentTopicIndex].completed = true;
                saveCloudData();
                renderTopics();
            }
        }
        
        window.deleteTopic = () => {
            if(confirm("Delete topic?")) {
                courses[currentCourseIndex].topics.splice(currentTopicIndex, 1);
                saveCloudData();
                renderTopics();
                if(courses[currentCourseIndex].topics.length > 0) loadTopic(0);
            }
        }
        
        window.deleteCourse = () => {
             if(confirm("Delete Course?")) {
                 courses.splice(currentCourseIndex, 1);
                 saveCloudData();
                 switchView('home');
                 renderCourses();
             }
        }

        window.switchView = (v) => {
            document.getElementById('home-view').style.display = v==='home'?'flex':'none';
            document.getElementById('course-view').style.display = v==='course'?'flex':'none';
            document.getElementById('nav-home').classList.toggle('active', v==='home');
            document.getElementById('nav-course').classList.toggle('active', v==='course');
            if(v==='home') renderCourses();
        }

    </script>
</body>
</html>
