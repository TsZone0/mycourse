<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Study Portal (Cloud Sync)</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --sidebar-bg: #161b22;
            --nav-bg: #161b22;
            --card-bg: #161b22;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --success: #238636;
            --danger: #da3633;
            --pink-text: #ff79c6;
            --border: #30363d;
            --shadow: none;
        }

        [data-theme="light"] {
            --bg-dark: #f3f4f6;
            --sidebar-bg: #ffffff;
            --nav-bg: #ffffff;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --accent: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --pink-text: #db2777;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease; 
        }

        /* Login Screen */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: background-color 0.3s ease;
        }
        .login-card {
            background: var(--card-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border);
            width: 350px; text-align: center; box-shadow: var(--shadow);
        }
        .login-header { margin-bottom: 20px; }
        .login-toggle { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .toggle-btn { background: none; border: none; color: var(--text-muted); font-weight: bold; cursor: pointer; font-size: 1rem; padding-bottom: 5px; }
        .toggle-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        .login-input {
            width: 100%; padding: 12px; margin: 8px 0; background: var(--bg-dark);
            border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; outline: none;
        }
        .login-input:focus { border-color: var(--accent); }
        
        .google-btn {
            background: white; color: #333; padding: 10px 24px; border-radius: 6px; width: 100%;
            border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            font-size: 0.95rem; transition: 0.2s; margin-top: 15px;
        }
        .google-btn:hover { opacity: 0.9; }

        /* Navbar */
        .navbar {
            height: 60px; background-color: var(--nav-bg); border-bottom: 1px solid var(--border);
            display: none; align-items: center; justify-content: space-between; padding: 0 25px; z-index: 50;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .nav-links { display: flex; gap: 20px; height: 100%; }
        .nav-item { display: flex; align-items: center; cursor: pointer; color: var(--text-muted); padding: 0 10px; font-weight: 600; transition: 0.2s; }
        .nav-item:hover { color: var(--text-main); }
        .nav-item.active { color: var(--text-main); border-bottom: 2px solid var(--accent); }

        .theme-toggle {
            background: transparent; border: 1px solid var(--border); color: var(--text-main);
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            transition: 0.3s; margin-right: 10px;
        }
        .theme-toggle:hover { background: var(--bg-dark); border-color: var(--accent); }

        /* App Container */
        .app-container { display: none; flex: 1; overflow: hidden; position: relative; }

        /* Dashboard Grid */
        #home-view { width: 100%; height: 100%; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }
        .dashboard-row { display: flex; gap: 25px; flex-wrap: wrap; flex: 1; } 
        .dashboard-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }

        /* Stats & Heatmap */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; box-shadow: var(--shadow); }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--text-main); display: block; margin: 5px 0; }
        .stat-label { color: var(--text-muted); font-size: 0.85rem; }

        .heatmap-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; box-shadow: var(--shadow); }
        .heatmap-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .heatmap-month { display: flex; flex-direction: column; gap: 5px; }
        .heatmap-month-label { font-size: 0.8rem; color: var(--text-muted); font-weight: bold; }
        .heatmap-month-grid { display: grid; grid-template-columns: repeat(7, 10px); gap: 3px; }
        .heatmap-cell { width: 10px; height: 10px; border-radius: 2px; background: var(--bg-dark); border: 1px solid var(--border); }
        .h-l0 { background: var(--bg-dark); }
        .h-l1 { background: #0e4429; border-color: #0e4429; }
        .h-l2 { background: #006d32; border-color: #006d32; }
        .h-l3 { background: #26a641; border-color: #26a641; }
        .h-l4 { background: #39d353; border-color: #39d353; }
        [data-theme="light"] .h-l0 { background: #ebedf0; border-color: #e1e4e8; }
        [data-theme="light"] .h-l1 { background: #9be9a8; border-color: #9be9a8; }
        [data-theme="light"] .h-l2 { background: #40c463; border-color: #40c463; }
        [data-theme="light"] .h-l3 { background: #30a14e; border-color: #30a14e; }
        [data-theme="light"] .h-l4 { background: #216e39; border-color: #216e39; }

        /* Daily Goals */
        .goals-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; flex: 1; box-shadow: var(--shadow); }
        .goal-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .goal-input-group input { flex: 1; padding: 10px 15px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-main); outline: none; font-size: 0.95rem; transition: 0.3s; }
        .goal-input-group input:focus { border-color: var(--accent); }
        .goal-list { list-style: none; max-height: 300px; overflow-y: auto; }
        .goal-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid var(--border); }
        .goal-item:hover { background: rgba(128,128,128,0.1); }
        .goal-checkbox { width: 18px; height: 18px; accent-color: var(--success); cursor: pointer; }
        .goal-text { flex: 1; }
        .goal-done .goal-text { text-decoration: line-through; color: var(--text-muted); }
        .delete-goal { color: var(--text-muted); cursor: pointer; font-size: 1.2rem; padding: 0 5px; }
        .delete-goal:hover { color: var(--danger); }

        /* Courses */
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .course-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 6px; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow); }
        .course-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .add-new { border: 1px dashed var(--text-muted); display: flex; align-items: center; justify-content: center; flex-direction: column; background: transparent; box-shadow: none; }

        /* Sidebar & Player */
        #course-view { display: none; width: 100%; height: 100%; }
        .sidebar { width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; }
        .main-content { flex: 1; padding: 40px; background: var(--bg-dark); overflow-y: auto; display: flex; flex-direction: column; transition: 0.3s; }
        
        .topic-item { padding: 12px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-muted); transition: 0.2s; border: 1px solid transparent; }
        .topic-item:hover { background: rgba(128,128,128,0.1); color: var(--text-main); }
        .topic-item.active { background: #1f6feb; color: white; }
        .topic-item.completed { background-color: var(--success) !important; color: white !important; font-weight: bold; border: 1px solid #2ea043; }
        [data-theme="light"] .topic-item.completed { color: white !important; }
        .topic-item.completed { color: var(--pink-text) !important; }

        .cinema-container { width: 100%; max-width: 900px; aspect-ratio: 16/9; background: #000; border-radius: 6px; margin-bottom: 20px; border: 1px solid var(--border); }
        iframe { width: 100%; height: 100%; border: none; }

        /* Note Section */
        .notes-section { width: 100%; max-width: 900px; margin-top: 30px; background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .notes-area { width: 100%; height: 200px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-main); padding: 15px; border-radius: 6px; resize: vertical; font-size: 0.95rem; line-height: 1.5; font-family: 'Courier New', Courier, monospace; transition: 0.3s; }
        .notes-area:focus { border-color: var(--accent); outline: none; }

        /* Utilities */
        .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid rgba(27,31,36,0.15); cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: #238636; color: white; border: 1px solid rgba(27,31,36,0.15); }
        .btn-primary:hover { background: #2ea043; transform: translateY(-1px); }
        .btn-complete-done { background-color: var(--success) !important; color: var(--pink-text) !important; border-color: #2ea043; font-weight: bold; }
        [data-theme="light"] .btn-complete-done { color: white !important; }

        .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--border); }
        .btn-danger:hover { color: white; background: var(--danger); border-color: var(--danger); }

        /* Footer */
        .app-footer { text-align: center; padding: 25px; margin-top: 40px; color: var(--text-muted); font-size: 0.85rem; border-top: 1px solid var(--border); background: var(--nav-bg); width: 100%; transition: 0.3s; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 6px; width: 400px; border: 1px solid var(--border); position: relative; box-shadow: var(--shadow); }
        .modal input { width: 100%; padding: 8px 12px; margin: 10px 0; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; }

        .contact-link { display: flex; align-items: center; gap: 15px; color: var(--text-main); text-decoration: none; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px; transition: 0.2s; }
        .contact-link:hover { border-color: var(--accent); color: var(--accent); transform: translateX(5px); }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Chat Styles */
        .chat-history { 
            flex: 1; overflow-y: auto; border: 1px solid var(--border); 
            border-radius: 6px; padding: 15px; margin-bottom: 15px; 
            background: var(--bg-dark); min-height: 300px; max-height: 400px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .chat-msg { 
            padding: 10px 14px; border-radius: 12px; max-width: 85%; 
            line-height: 1.5; font-size: 0.95rem; word-wrap: break-word;
        }
        .msg-user { 
            background: var(--accent); color: white; align-self: flex-end; 
            border-bottom-right-radius: 2px;
        }
        .msg-ai { 
            background: var(--border); color: var(--text-main); align-self: flex-start; 
            border-bottom-left-radius: 2px;
        }
        .typing-dot {
            display: inline-block; width: 6px; height: 6px; background: var(--text-muted);
            border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <h1 class="login-header">üéì Study Portal</h1>
            <p style="margin-bottom: 15px; color: var(--text-muted);">Environment Auto-Login Enabled</p>
            
            <!-- Toggle Tabs -->
            <div class="login-toggle">
                <button class="toggle-btn active" id="tab-login" onclick="toggleAuthMode('login')">Login</button>
                <button class="toggle-btn" id="tab-signup" onclick="toggleAuthMode('signup')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div id="login-form">
                <input type="email" id="login-email" class="login-input" placeholder="Email Address">
                <input type="password" id="login-pass" class="login-input" placeholder="Password">
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="handleEmailLogin()">Login</button>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" style="display: none;">
                <input type="text" id="signup-name" class="login-input" placeholder="Full Name">
                <input type="email" id="signup-email" class="login-input" placeholder="Email Address">
                <input type="password" id="signup-pass" class="login-input" placeholder="Password (Min 6 chars)">
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="handleSignUp()">Create Account</button>
            </div>

            <div class="loader" id="auth-loader" style="display: block;"></div>
            <p id="login-error" style="color: var(--danger); margin-top: 20px; display: none; font-size: 0.9rem;"></p>

            <!-- Divider -->
            <div style="margin: 20px 0; color: var(--text-muted); font-size: 0.8rem;">OR</div>

            <!-- Google Login -->
            <button class="google-btn" onclick="handleGoogleLogin()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20" alt="G">
                Continue with Google
            </button>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar" id="main-nav">
        <div class="logo" onclick="switchView('home')" style="font-weight:bold; cursor:pointer;">üéì Study Portal</div>
        <div class="nav-links">
            <div class="nav-item active" id="nav-home" onclick="switchView('home')">Dashboard</div>
            <div class="nav-item" id="nav-course" onclick="if(currentCourseIndex > -1) switchView('course')">Course</div>
            <div class="nav-item" onclick="document.getElementById('about-modal').style.display='flex'">About</div>
            <div class="nav-item" onclick="document.getElementById('contact-modal').style.display='flex'">Contact</div>
            <!-- AI ASK BUTTON ADDED HERE -->
            <div class="nav-item" style="color: var(--accent);" onclick="openAIModal()">ü§ñ AI Ask</div>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                <span id="theme-icon">üåô</span>
            </button>
            <div style="color: var(--accent); font-weight: bold;">‚è±Ô∏è <span id="session-timer">00:00</span></div>
            <img id="user-pic" src="" style="width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); display:none;" alt="U">
            <button class="btn" style="padding: 4px 10px; font-size: 0.8rem;" onclick="handleLogout()">Logout</button>
        </div>
    </nav>

    <!-- Main App -->
    <div class="app-container" id="main-app">
        <!-- Dashboard content -->
        <div id="home-view">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 id="welcome-msg" style="font-size: 1.5rem;">Welcome!</h1>
            </div>
            <div class="dashboard-row">
                <div class="dashboard-col" style="flex: 2;">
                    <div class="stats-grid">
                        <div class="stat-card"><span class="stat-label">Study Today</span><span class="stat-value" id="stat-today">0m</span></div>
                        <div class="stat-card"><span class="stat-label">Total Hours</span><span class="stat-value" id="stat-total">0h</span></div>
                    </div>
                    <div class="heatmap-card">
                        <h3 style="margin-bottom: 15px; font-size: 1rem;">Study Consistency</h3>
                        <div class="heatmap-container" id="heatmap-grid"></div>
                    </div>
                    <h3 style="margin-top: 10px;">My Courses</h3>
                    <div class="courses-grid" id="courses-grid">
                        <div class="course-card add-new" onclick="openCreateModal()"><span style="font-size: 1.5rem;">+</span><span>New Course</span></div>
                    </div>
                </div>
                <div class="dashboard-col" style="flex: 1;">
                    <div class="goals-card">
                        <h3 style="margin-bottom: 15px; font-size: 1rem;">üéØ Daily Goals</h3>
                        <div class="goal-input-group">
                            <input type="text" id="new-goal-input" placeholder="Add task..." onkeypress="if(event.key==='Enter') addGoal()">
                            <button class="btn btn-primary" onclick="addGoal()">Add</button>
                        </div>
                        <ul class="goal-list" id="goal-list"></ul>
                    </div>
                </div>
            </div>
            <div class="app-footer">&copy; 2025 Copyright by <strong>Shivam Kumar (TIT(Excellence))</strong></div>
        </div>

        <!-- COURSE PLAYER -->
        <div id="course-view">
            <div class="sidebar">
                <div style="padding: 20px; border-bottom: 1px solid var(--border); background: var(--nav-bg);">
                    <h3 id="course-title-display" style="font-size: 1rem;">Loading...</h3>
                    <div style="margin-top: 10px; background: var(--border); height: 4px; border-radius: 2px;">
                        <div id="progress-bar" style="width: 0%; background: var(--success); height: 100%; border-radius: 2px;"></div>
                    </div>
                </div>
                <div class="topic-list" id="topic-list" style="padding: 10px;"></div>
            </div>
            <div class="main-content">
                <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <button class="btn" onclick="switchView('home')">‚Üê Dashboard</button>
                        <button class="btn btn-primary" onclick="document.getElementById('add-topic-modal').style.display='flex'">+ Add Topic</button>
                    </div>
                    <div class="cinema-container"><iframe id="video-player" src="" allowfullscreen></iframe></div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="mark-btn" class="btn btn-primary" style="flex:1; padding: 12px;" onclick="markComplete()">‚úÖ Mark as Completed</button>
                        <button class="btn btn-danger" onclick="deleteTopic()" style="padding: 12px;">üóëÔ∏è</button>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                        <h2 id="video-title" style="color: var(--text-main);">Select Topic</h2>
                        <small id="completion-date" style="color: var(--pink-text); display: none;"></small>
                    </div>
                    <p id="video-desc" style="color: var(--text-muted); margin-top: 5px; margin-bottom: 20px;">...</p>
                    <div class="notes-section">
                        <h3>üìù Lecture Notes <span id="save-status" style="margin-left: auto; font-size: 0.8rem; color: var(--success);"></span></h3>
                        <textarea id="topic-notes" class="notes-area" placeholder="Write your key points here..."></textarea>
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="saveCurrentNote()">Save Note</button>
                    </div>
                    <button class="btn btn-danger" style="margin-top: 40px;" onclick="deleteCourse()">Delete Entire Course</button>
                </div>
                <div class="app-footer">&copy; 2025 Copyright by <strong>Shivam Kumar (TIT(Excellence))</strong></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="create-course-modal">
        <div class="modal-content">
            <h2>New Course</h2>
            <input type="text" id="new-course-name" placeholder="Course Name">
            <button class="btn btn-primary" style="width: 100%;" onclick="createNewCourse()">Create</button>
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="document.getElementById('create-course-modal').style.display='none'">Cancel</button>
        </div>
    </div>
    <div class="modal" id="add-topic-modal">
        <div class="modal-content">
            <h2>Add Lecture</h2>
            <input type="text" id="inp-title" placeholder="Title">
            <input type="text" id="inp-link" placeholder="YouTube Link">
            <input type="text" id="inp-desc" placeholder="Description">
            <button class="btn btn-primary" style="width: 100%;" onclick="addTopic()">Add</button>
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="document.getElementById('add-topic-modal').style.display='none'">Cancel</button>
        </div>
    </div>
    
    <!-- About Modal -->
    <div class="modal" id="about-modal">
        <div class="modal-content" style="width: 500px;">
            <h2 style="margin-bottom: 20px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px;">üë®‚Äçüíª About Us</h2>
            
            <p style="color: var(--text-main); font-size: 1.05rem; line-height: 1.6; margin-bottom: 15px;">
                Hello everyone! I am <strong>Shivam Kumar</strong>, a passionate 2nd-year Computer Science Engineering student at <strong>TIT (Excellence)</strong>. üéì
            </p>

            <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 15px;">
                My journey into the world of technology has been driven by a single goal: to solve real-world problems using code. As a student myself, I realized that while platforms like YouTube have amazing educational content, they are also filled with distractions. One moment you are learning Data Structures, and the next you are watching funny videos.
            </p>

            <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 20px;">
                That is why I created this <strong>'Pro Study Portal'</strong>. It is a sanctuary for students‚Äîa place where you can organize your learning, track your progress with heatmaps, and maintain a focused study streak without the noise. This project is my contribution to helping every student achieve their academic goals with discipline and consistency.
            </p>
            
            <p style="color: var(--accent); font-weight: bold; text-align: center;">"Let's Crack It Together! üöÄ"</p>

            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="document.getElementById('about-modal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal" id="contact-modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: var(--accent);">üìû Contact Us</h2>
            <a href="mailto:tszone@zohomail.in" class="contact-link"><span>üìß</span><div><div style="font-size: 0.8rem; color: var(--text-muted);">Email</div><div style="font-weight: bold;">tszone@zohomail.in</div></div></a>
            <a href="#" class="contact-link"><span>üíº</span><div><div style="font-size: 0.8rem; color: var(--text-muted);">LinkedIn</div><div style="font-weight: bold;">Connect with Shivam</div></div></a>
            <a href="#" class="contact-link"><span>üì∏</span><div><div style="font-size: 0.8rem; color: var(--text-muted);">Instagram</div><div style="font-weight: bold;">Follow for Updates</div></div></a>
            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="document.getElementById('contact-modal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- AI ASK MODAL (NEW) -->
    <div class="modal" id="ai-modal">
        <div class="modal-content" style="width: 550px; display: flex; flex-direction: column; height: 80vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                <h2 style="color: var(--accent); display: flex; align-items: center; gap: 10px;">ü§ñ AI Study Assistant</h2>
                <button class="btn" onclick="document.getElementById('ai-modal').style.display='none'">Close</button>
            </div>
            
            <!-- Chat History -->
            <div id="chat-history" class="chat-history">
                <div class="chat-msg msg-ai">Hello! I am your AI study buddy. How can I help you with your coursework today? üìö</div>
            </div>

            <!-- Input Area -->
            <div style="display: flex; gap: 10px; margin-top: auto;">
                <input type="text" id="ai-input" placeholder="Ask a doubt (e.g., 'Explain Recursion')..." style="flex: 1;" onkeypress="if(event.key==='Enter') handleAiQuery()">
                <button class="btn btn-primary" onclick="handleAiQuery()" id="send-ai-btn">Send</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            updateProfile, 
            signOut, 
            onAuthStateChanged,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCf-BoHSE_-2YhF7DAbxYXT0cHOprE9rzk",
            authDomain: "mycourse-231f1.firebaseapp.com",
            projectId: "mycourse-231f1",
            storageBucket: "mycourse-231f1.firebasestorage.app",
            messagingSenderId: "519848272346",
            appId: "1:519848272346:android:b495935905823e921920e3" 
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        let app, auth, db, user;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase Init Error", e); }

        // --- STATE ---
        let courses = [], studyData = {}, dailyGoals = [];
        let currentCourseIndex = -1, currentTopicIndex = -1, sessionSeconds = 0, isSaving = false;
        let dataUnsubscribe = null; // For cleaning up listener

        // --- AUTH INITIALIZATION ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                   // Fallback
                }
            } catch (error) {
                console.error("Auth Error:", error);
                showAuthError(error.message);
            }
        };
        initAuth();

        // --- AUTH UI TOGGLE ---
        window.toggleAuthMode = (mode) => {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const tabLogin = document.getElementById('tab-login');
            const tabSignup = document.getElementById('tab-signup');
            const errorMsg = document.getElementById('login-error');
            
            errorMsg.style.display = 'none';

            if (mode === 'login') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
                tabLogin.classList.add('active');
                tabSignup.classList.remove('active');
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
                tabLogin.classList.remove('active');
                tabSignup.classList.add('active');
            }
        }

        // --- AUTH ACTIONS ---
        window.handleEmailLogin = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) return alert("Please enter all fields");

            document.getElementById('auth-loader').style.display = 'block';
            signInWithEmailAndPassword(auth, email, pass).catch((error) => showAuthError(error.message));
        }

        window.handleSignUp = () => {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;

            if(!name || !email || !pass) return alert("Please enter all fields");

            document.getElementById('auth-loader').style.display = 'block';
            createUserWithEmailAndPassword(auth, email, pass)
                .then((result) => {
                    updateProfile(result.user, { displayName: name })
                        .then(() => { document.getElementById('welcome-msg').innerText = `Welcome back, ${name}! üëã`; });
                })
                .catch((error) => showAuthError(error.message));
        }

        window.handleGoogleLogin = () => {
            document.getElementById('auth-loader').style.display = 'block';
            signInWithPopup(auth, new GoogleAuthProvider()).catch(e => showAuthError(e.message));
        }

        function showAuthError(msg) {
            const el = document.getElementById('login-error');
            el.innerText = msg.replace("Firebase: ", "");
            el.style.display = 'block';
            document.getElementById('auth-loader').style.display = 'none';
        }

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (u) => {
            document.getElementById('auth-loader').style.display = 'none';
            if (u) {
                user = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-nav').style.display = 'flex';
                document.getElementById('main-app').style.display = 'flex';
                
                const name = user.displayName || 'Student';
                document.getElementById('welcome-msg').innerText = `Welcome back, ${name}! üëã`;
                
                if(user.photoURL) {
                    document.getElementById('user-pic').src = user.photoURL;
                    document.getElementById('user-pic').style.display = 'block';
                }
                // Setup real-time data listener
                setupDataListener();
                initApp();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                if(dataUnsubscribe) dataUnsubscribe();
            }
        });

        // --- CLOUD & APP LOGIC (FIXED RESET ISSUE) ---
        function setupDataListener() {
            if (dataUnsubscribe) dataUnsubscribe();
            try {
                // Using onSnapshot for Real-time updates so data is always sync
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'profile');
                dataUnsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Only update if we are not currently saving to avoid conflict loop
                        if (!isSaving) {
                            courses = data.courses || [];
                            studyData = data.studyData || {};
                            dailyGoals = data.dailyGoals || [];
                            renderCourses(); // Re-render in case of external update
                            renderHeatmap();
                            renderGoals();
                            updateStats();
                        }
                    } else {
                        // No data yet, initialize
                        courses = []; studyData = {}; dailyGoals = [];
                        saveCloudData();
                    }
                }, (error) => {
                    console.error("Data fetch error:", error);
                });
            } catch (e) { console.error("Listener Setup Error", e); }
        }

        async function saveCloudData() {
            if (!user || isSaving) return;
            // Safety check: Don't save if data is empty to prevent overwrite on load fail
            if (Object.keys(studyData).length === 0 && courses.length === 0 && sessionSeconds > 5) {
                // Proceed only if it's a fresh start, otherwise might be risk
            }
            
            isSaving = true;
            try { 
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'profile'), { courses, studyData, dailyGoals }, { merge: true }); 
                console.log("Saved successfully");
            } catch(e) { console.error("Save error", e); }
            isSaving = false;
        }

        function initApp() {
            // Initial render handled by snapshot listener mostly
            setInterval(() => { sessionSeconds++; updateTimer(); }, 1000);
            // Auto-save every 10 seconds
            setInterval(() => { 
                if(user) {
                    const today = new Date().toISOString().split('T')[0];
                    studyData[today] = (studyData[today] || 0) + 10; 
                    saveCloudData(); 
                    updateStats(); 
                }
            }, 10000);
        }

        // --- AI CHAT LOGIC (FIXED ERROR HANDLING) ---
        window.openAIModal = () => {
            document.getElementById('ai-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('ai-input').focus(), 100);
        }

        window.handleAiQuery = async () => {
            const input = document.getElementById('ai-input');
            const query = input.value.trim();
            const btn = document.getElementById('send-ai-btn');
            
            if (!query) return;

            addChatMsg(query, 'user');
            input.value = '';
            btn.disabled = true;
            btn.innerText = "...";

            const loadingId = addChatMsg('<div class="typing-dot"></div><div class="typing-dot"></div>', 'ai');

            try {
                const apiKey = ""; // Environment provided
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "Answer this concisely for a student: " + query }] }]
                    })
                });

                document.getElementById(loadingId).remove();

                if(response.ok) {
                    const responseData = await response.json();
                    if (responseData && responseData.candidates && responseData.candidates[0].content) {
                        const aiText = responseData.candidates[0].content.parts[0].text;
                        const formattedText = aiText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                        addChatMsg(formattedText, 'ai');
                    } else {
                        addChatMsg("Sorry, I couldn't interpret the response.", 'ai');
                    }
                } else {
                    // Show specific error code to help debug
                    addChatMsg(`Sorry, I encountered an error. (Status: ${response.status} - ${response.statusText}). Please check your API Key or Network.`, 'ai');
                }

            } catch (error) {
                document.getElementById(loadingId)?.remove();
                addChatMsg("Connection Error: " + error.message, 'ai');
            } finally {
                btn.disabled = false;
                btn.innerText = "Send";
            }
        }

        function addChatMsg(html, type) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-msg msg-${type}`;
            div.innerHTML = html;
            div.id = 'msg-' + Date.now();
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div.id;
        }

        // --- THEME ---
        window.toggleTheme = () => {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            document.getElementById('theme-icon').innerText = next === 'light' ? '‚òÄÔ∏è' : 'üåô';
        }
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.addEventListener('DOMContentLoaded', () => document.getElementById('theme-icon').innerText = savedTheme === 'light' ? '‚òÄÔ∏è' : 'üåô');

        // --- LOGIC FUNCTIONS ---
        window.openCreateModal = () => document.getElementById('create-course-modal').style.display='flex';
        window.createNewCourse = () => {
            const name = document.getElementById('new-course-name').value;
            if(name) { courses.push({ name, topics: [] }); saveCloudData(); renderCourses(); document.getElementById('create-course-modal').style.display='none'; }
        }
        function renderCourses() {
            const grid = document.getElementById('courses-grid');
            const addBtn = grid.querySelector('.add-new');
            grid.querySelectorAll('.course-card:not(.add-new)').forEach(e => e.remove());
            courses.forEach((c, idx) => {
                const div = document.createElement('div');
                div.className = 'course-card';
                div.innerHTML = `<h3>${c.name}</h3><p style="color:var(--text-muted); font-size:0.9rem;">${c.topics.length} Topics</p>`;
                div.onclick = () => loadCourse(idx);
                grid.insertBefore(div, addBtn);
            });
        }
        window.loadCourse = (idx) => {
            currentCourseIndex = idx;
            const c = courses[idx];
            document.getElementById('course-title-display').innerText = c.name;
            switchView('course');
            renderTopics();
            if(c.topics.length > 0) loadTopic(0);
            else {
                document.getElementById('video-player').src = '';
                document.getElementById('video-title').innerText = "No Topic";
                document.getElementById('mark-btn').style.display = 'none';
                document.getElementById('topic-notes').value = "";
            }
        }
        function renderTopics() {
            const list = document.getElementById('topic-list');
            list.innerHTML = '';
            const t = courses[currentCourseIndex].topics;
            let done = 0;
            t.forEach((topic, i) => {
                if(topic.completed) done++;
                const div = document.createElement('div');
                div.className = `topic-item ${i===currentTopicIndex?'active':''} ${topic.completed?'completed':''}`;
                div.innerHTML = `<span>${i+1}. ${topic.title}</span><span>${topic.completed?'‚úì':''}</span>`;
                div.onclick = () => loadTopic(i);
                list.appendChild(div);
            });
            document.getElementById('progress-bar').style.width = t.length ? (done/t.length)*100+'%' : '0%';
        }
        window.loadTopic = (i) => {
            currentTopicIndex = i;
            const t = courses[currentCourseIndex].topics[i];
            document.getElementById('video-player').src = t.url;
            document.getElementById('video-title').innerText = t.title;
            document.getElementById('video-desc').innerText = t.desc;
            document.getElementById('topic-notes').value = t.notes || "";
            document.getElementById('save-status').innerText = "";
            const btn = document.getElementById('mark-btn');
            const dateEl = document.getElementById('completion-date');
            btn.style.display = 'block';
            if (t.completed) {
                btn.innerHTML = "üéâ Completed";
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-complete-done');
                if(t.completedOn) {
                    const date = new Date(t.completedOn).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    dateEl.innerText = `Completed on: ${date}`;
                    dateEl.style.display = 'block';
                }
            } else {
                btn.innerHTML = "‚úÖ Mark as Completed";
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-complete-done');
                dateEl.style.display = 'none';
            }
            renderTopics();
        }
        window.addTopic = () => {
            const title = document.getElementById('inp-title').value;
            const link = document.getElementById('inp-link').value;
            const desc = document.getElementById('inp-desc').value;
            const match = link.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?]*).*/);
            if(match && match[2].length===11) {
                courses[currentCourseIndex].topics.push({
                    title, desc, completed: false, completedOn: null, notes: "",
                    url: `https://www.youtube.com/embed/${match[2]}?modestbranding=1&rel=0&loop=1&playlist=${match[2]}`
                });
                saveCloudData();
                renderTopics();
                document.getElementById('add-topic-modal').style.display='none';
                if(courses[currentCourseIndex].topics.length===1) loadTopic(0);
            } else { alert("Invalid Link"); }
        }
        window.markComplete = () => {
            if(currentTopicIndex > -1) {
                const topic = courses[currentCourseIndex].topics[currentTopicIndex];
                topic.completed = !topic.completed;
                topic.completedOn = topic.completed ? new Date().toISOString() : null;
                saveCloudData();
                loadTopic(currentTopicIndex);
            }
        }
        window.deleteTopic = () => {
            if(confirm("Delete topic?")) {
                courses[currentCourseIndex].topics.splice(currentTopicIndex, 1);
                saveCloudData();
                renderTopics();
                if(courses[currentCourseIndex].topics.length > 0) loadTopic(0);
            }
        }
        window.deleteCourse = () => {
             if(confirm("Delete Course?")) {
                 courses.splice(currentCourseIndex, 1);
                 saveCloudData();
                 switchView('home');
                 renderCourses();
             }
        }
        window.saveCurrentNote = () => {
            if(currentTopicIndex > -1 && currentCourseIndex > -1) {
                const noteContent = document.getElementById('topic-notes').value;
                courses[currentCourseIndex].topics[currentTopicIndex].notes = noteContent;
                saveCloudData();
                const status = document.getElementById('save-status');
                status.innerText = "Saved to Cloud ‚úÖ";
                setTimeout(() => status.innerText = "", 2000);
            }
        }
        window.addGoal = () => {
            const input = document.getElementById('new-goal-input');
            const txt = input.value.trim();
            if (txt) { dailyGoals.push({ text: txt, done: false }); saveCloudData(); renderGoals(); input.value = ''; }
        }
        window.toggleGoal = (idx) => { dailyGoals[idx].done = !dailyGoals[idx].done; saveCloudData(); renderGoals(); }
        window.deleteGoal = (idx) => { dailyGoals.splice(idx, 1); saveCloudData(); renderGoals(); }
        function renderGoals() {
            const list = document.getElementById('goal-list');
            list.innerHTML = '';
            dailyGoals.forEach((g, i) => {
                const li = document.createElement('li');
                li.className = `goal-item ${g.done ? 'goal-done' : ''}`;
                li.innerHTML = `<input type="checkbox" class="goal-checkbox" ${g.done ? 'checked' : ''} onchange="toggleGoal(${i})"><span class="goal-text">${g.text}</span><span class="delete-goal" onclick="deleteGoal(${i})">√ó</span>`;
                list.appendChild(li);
            });
        }
        function updateTimer() {
            const m = Math.floor(sessionSeconds/60);
            const s = sessionSeconds%60;
            document.getElementById('session-timer').innerText = `${m}:${s<10?'0'+s:s}`;
        }
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const tSec = studyData[today] || 0;
            let total = 0;
            Object.values(studyData).forEach(v => total += v);
            document.getElementById('stat-today').innerText = (tSec/60).toFixed(0) + 'm';
            document.getElementById('stat-total').innerText = (total/3600).toFixed(1) + 'h';
        }
        function renderHeatmap() {
            const container = document.getElementById('heatmap-grid');
            container.innerHTML = '';
            const today = new Date();
            for (let i = 11; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthName = d.toLocaleString('default', { month: 'short' });
                const year = d.getFullYear();
                const daysInMonth = new Date(year, d.getMonth() + 1, 0).getDate();
                const monthDiv = document.createElement('div');
                monthDiv.className = 'heatmap-month';
                const label = document.createElement('div');
                label.className = 'heatmap-month-label';
                label.innerText = `${monthName}`;
                monthDiv.appendChild(label);
                const grid = document.createElement('div');
                grid.className = 'heatmap-month-grid';
                for(let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(d.getMonth()+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const seconds = studyData[dateStr] || 0;
                    const mins = seconds / 60;
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.title = `${dateStr}: ${Math.round(mins)} mins`;
                    if (mins > 120) cell.classList.add('h-l4'); else if (mins > 60) cell.classList.add('h-l3'); else if (mins > 30) cell.classList.add('h-l2'); else if (mins > 0) cell.classList.add('h-l1'); else cell.classList.add('h-l0');
                    grid.appendChild(cell);
                }
                monthDiv.appendChild(grid);
                container.appendChild(monthDiv);
            }
        }
        window.switchView = (v) => {
            document.getElementById('home-view').style.display = v==='home'?'flex':'none';
            document.getElementById('course-view').style.display = v==='course'?'flex':'none';
            document.getElementById('nav-home').classList.toggle('active', v==='home');
            document.getElementById('nav-course').classList.toggle('active', v==='course');
            if(v==='home') renderCourses();
        }

    </script>
</body>
</html>
